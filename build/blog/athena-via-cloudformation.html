<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Using CloudFormation to create Athena tables (tris.fyi)</title>
        <link rel="stylesheet" href="/static/index2.css">
        
<link rel="stylesheet" href="/static/pygments.css">

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
    </head>
    <body>
        <header>
            
<span><a href="/">tris.fyi</a> &gt; <a href="/blog/">blog</a> &gt;</span>
<h1>Using CloudFormation to create Athena tables</h1>
<div>
    
    <em>
        
        posted 2022-11-07
        
    </em>
</div>
<hr />

<details>
    <summary>Table of Contents</summary>
    <div class="toc">
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#simple-example">Simple example</a></li>
<li><a href="#defining-partition-projection">Defining partition projection</a></li>
</ul>
</div>

</details>
<hr />


        </header>
        <main>
            
<h2 id="background">Background</h2>
<p>If you use <a href="https://aws.amazon.com/athena/">Amazon Athena</a> to query data stored in <a href="https://aws.amazon.com/s3/">Amazon S3</a> (for example, log files, or large datasets used for analysis), you may find yourself wanting to version-control table definitions using <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a>. Since Athena uses the <a href="https://aws.amazon.com/glue/">AWS Glue</a> data catalog underneath, you can create <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-glue-table.html">Glue tables</a> to populate your Athena databases.</p>
<p>(You should note that, with a bit of effort, you can likely adapt this information to e.g. <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/glue_catalog_table">Terraform's Glue table resource</a>.)</p>
<h2 id="simple-example">Simple example</h2>
<p>Using the <a href="https://docs.aws.amazon.com/athena/latest/ug/getting-started.html">CloudFront Logs example</a> table, here's a resource definition suitable for a CloudFormation YAML template:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">CloudfrontLogsTable</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;AWS::Glue::Table&quot;</span>
<span class="w">  </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">    </span><span class="nt">CatalogId</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="s">&quot;AWS::AccountId&quot;</span>
<span class="w">    </span><span class="nt">DatabaseName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">    </span><span class="nt">TableInput</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cloudfront_logs</span>
<span class="w">      </span><span class="nt">TableType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EXTERNAL_TABLE</span>
<span class="w">      </span><span class="nt">StorageDescriptor</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Location</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3://athena-examples-us-east-1/cloudfront/plaintext/&quot;</span>
<span class="w">        </span><span class="nt">StoredAsSubDirectories</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">        </span><span class="nt">InputFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">org.apache.hadoop.mapred.TextInputFormat</span>
<span class="w">        </span><span class="nt">OutputFormat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IgnoreKeyTextOutputFormat</span>

<span class="w">        </span><span class="nt">SerdeInfo</span><span class="p">:</span>
<span class="w">          </span><span class="nt">SerializationLibrary</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span>
<span class="w">          </span><span class="nt">Parameters</span><span class="p">:</span>
<span class="w">            </span><span class="nt">field.delim</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;\t&quot;</span>
<span class="w">            </span><span class="nt">serialization.format</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;\t&quot;</span>

<span class="w">        </span><span class="nt">Columns</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Date</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">date</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Time</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Location</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Bytes</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RequestIP</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Method</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Host</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Uri</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Status</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Referrer</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClientInfo</span>
<span class="w">            </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</code></pre></div>

<h2 id="defining-partition-projection">Defining partition projection</h2>
<p><a href="https://docs.aws.amazon.com/athena/latest/ug/partition-projection.html">Partition projection</a> is supported here too. For example, on a CloudTrail logs table with partition projection:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">CloudtrailLogsTable</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">    </span><span class="nt">TableInput</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nt">projection.enabled</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">        </span><span class="nt">projection.timestamp.type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;date&quot;</span>
<span class="w">        </span><span class="nt">projection.timestamp.format</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yyyy/MM/dd&quot;</span>
<span class="w">        </span><span class="nt">projection.timestamp.interval</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">        </span><span class="nt">projection.timestamp.interval.unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DAYS&quot;</span>
<span class="w">        </span><span class="nt">projection.awsregion.type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;enum&quot;</span>
<span class="w">        </span><span class="nt">projection.awsregion.values</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;us-east-1,us-east-2&quot;</span>
<span class="w">        </span><span class="nt">storage.location.template</span><span class="p">:</span><span class="w"> </span><span class="kt">!Sub</span><span class="w"> </span><span class="s">&quot;s3://my-cloudtrail-logs/AWSLogs/${AWS::AccountId}/CloudTrail/${!awsregion}/${!timestamp}&quot;</span>

<span class="w">      </span><span class="nt">PartitionKeys</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awsregion</span>
<span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>

<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">timestamp</span>
<span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</code></pre></div>

        </main>
        <footer>
            
        </footer>
    </body>
</html>